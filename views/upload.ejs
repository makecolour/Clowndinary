<div class="row justify-content-center" ng-app="clowndinaryApp" ng-controller="UploadController">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">
                    <i class="fas fa-upload me-2"></i>
                    Upload Images
                </h2>
                
                <% if (locals.error) { %>
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <%= error %>
                    </div>
                <% } %>
                
                <% if (locals.success) { %>
                    <div class="alert alert-success" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <%= success %>
                        <% if (locals.query && locals.query.batchId) { %>
                            <div class="mt-2">
                                <a href="/export-csv/<%= locals.query.batchId %>" class="btn btn-sm btn-success">
                                    <i class="fas fa-download me-1"></i>
                                    Export CSV for this batch
                                </a>
                            </div>
                        <% } %>
                    </div>
                <% } %>

                <form method="POST" action="/upload" enctype="multipart/form-data" id="uploadForm">
                    <div class="mb-4">
                        <label for="images" class="form-label">Select Images</label>
                        <input type="file" 
                               class="form-control" 
                               id="images" 
                               name="images" 
                               multiple 
                               accept="image/*" 
                               required>
                        <div class="form-text">
                            Select multiple images (JPG, PNG, GIF, etc.).
                        </div>
                    </div>
                        <div class="mb-4">
                            <label for="storageProvider" class="form-label">Choose Storage Provider</label>
                            <select class="form-select" id="storageProvider" name="storageProvider" required>
                                <option value="cloudinary">Cloudinary</option>
                                <option value="bunny">Bunny Storage</option>
                            </select>
                            <div class="form-text">
                                Select where you want to upload your images.
                            </div>
                        </div>
                    
                    <div id="preview" class="mb-4" style="display: none;">
                        <h5>Preview:</h5>
                        <div id="previewContainer" class="row"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100" id="uploadBtn">
                        <i class="fas fa-upload me-2"></i>
                        Upload Images
                    </button>
                </form>
                
                <div class="text-center mt-3">
                    <a href="/dashboard" class="text-decoration-none">
                        <i class="fas fa-arrow-left me-1"></i>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    angular.module('clowndinaryApp', [])
    .controller('UploadController', function($scope) {
        $scope.files = [];
        $scope.isUploading = false;
        
        // File selection handler
        $('#images').on('change', function(e) {
            $scope.$apply(function() {
                $scope.files = Array.from(e.target.files);
                $scope.showPreview();
            });
        });
        
        $scope.showPreview = function() {
            const preview = $('#preview');
            const previewContainer = $('#previewContainer');
            
            if ($scope.files.length > 0) {
                previewContainer.empty();
                preview.show();
                
                $scope.files.forEach(function(file) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const col = $('<div class="col-md-3 mb-3">');
                            col.html('<div class="card">' +
                                '<img src="' + e.target.result + '" class="card-img-top" style="height: 150px; object-fit: cover;" alt="' + file.name + '">' +
                                '<div class="card-body p-2">' +
                                '<small class="text-truncate d-block" title="' + file.name + '">' + file.name + '</small>' +
                                '<small class="text-muted">' + Math.round(file.size / 1024) + ' KB</small>' +
                                '</div></div>');
                            previewContainer.append(col);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            } else {
                preview.hide();
            }
        };
        
        $scope.submitUpload = function() {
            $scope.isUploading = true;
            toastr.info('Uploading ' + $scope.files.length + ' images to Cloudinary...');
        };
        
        $scope.exportCSV = function(batchId) {
            toastr.info('Preparing CSV export...');
            window.location.href = '/export-csv/' + batchId;
        };
        
        // Show messages using toastr
        <% if (locals.error) { %>
            toastr.error('<%= error %>');
        <% } %>
        <% if (locals.success) { %>
            toastr.success('<%= success %>');
        <% } %>
    });
</script>